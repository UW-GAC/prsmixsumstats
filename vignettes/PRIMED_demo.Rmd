---
title: "Calculating summary statistics for elastic net"
author: "Dan Schaid"
date: "`r Sys.Date()`"
output: html_document
vignette: >
  %\VignetteIndexEntry{Calculating summary statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```


```{r}
library(prsmixsumstats)
```

Simulate test data of 3 groups with PRS (nprs) and covariates (sex, age, covs)

```{r}
nprs <- 500
n1 <- 100
n2 <- 200
n3 <- 100

dat1 <- sim_test_dat(n1, nprs)
dat2 <- sim_test_dat(n2, nprs)
dat3 <- sim_test_dat(n3, nprs)
```

# Biobanks Create Summary Statistics (3 demo biobanks)

```{r}
sumstat1 <- make_sumstats(dat1$x, dat1$y)
sumstat2 <- make_sumstats(dat2$x, dat2$y)
sumstat3 <- make_sumstats(dat3$x, dat3$y)
sumstats_all <- list(sumstat1, sumstat2, sumstat3)
```

# CC: sum over biobanks

```{r}
combo_sumstats <- combine_sumstats(sumstats_all)

sumstats <- combo_sumstats$sumstats
sumstats$vary <- combo_sumstats$yvar
```

# Fit glmnet_sumstats for a grid of alpha's & lambda's

```{r}
penalty_factor <- rep(1,ncol(sumstats$xx))

## alpha weights abs(beta) and (1-alpha) weights beta^2
alpha_grid <- seq(from=0.9, to=0.1, by= -0.2)
lambda_frac <- exp(seq(from=log(1), to=log(.05), length=10))

nlambda <- length(lambda_frac)
nalpha <- length(alpha_grid)

## note 2-dimensional grid of fits. Each fit is a list
## and all fits arranged as matrix (of lists)

fit_obs <- glmnet_sumstats_grid(sumstats, alpha_grid, lambda_frac, penalty_factor, maxiter=500, tol=1e-5, verbose=FALSE)
```


## metrics 

```{r}
metrics_obs <- metrics_sumstats(sumstats, fit_obs)
metrics_obs$bic_min_index
metrics_obs$loss_min_index

metrics_obs$auc[metrics_obs$bic_min_index]
metrics_obs$auc[metrics_obs$loss_min_index]

metrics_obs$nbeta[metrics_obs$bic_min_index]
metrics_obs$nbeta[metrics_obs$loss_min_index]
```



## plot loss across grid

```{r}
library(ggplot2)
library(reshape2)
colnames(metrics_obs$loss) <- lambda_frac
rownames(metrics_obs$loss) <- alpha_grid
mat_long <- melt(metrics_obs$loss)

names(mat_long) <- c("alpha", "lambda", "loss")
mat_long$label <- rep("above", nrow(mat_long))

k <- index_mat_to_vec(metrics_obs$loss_min_index[1],metrics_obs$loss_min_index[2], nrow(metrics_obs$loss))
mat_long$label[k] <- "min-loss"

k <- index_mat_to_vec(metrics_obs$bic_min_index[1],metrics_obs$bic_min_index[2] , nrow(metrics_obs$loss))
mat_long$label[k] <- "min-bic"

titl <- paste0("Loss Across Grid")

ggplot(mat_long, aes(x = lambda, y = alpha, color = label)) + 
  geom_point(aes(size = loss)) +
  scale_color_manual(values = c("min-loss" = "red", "min-bic" = "blue", "above" = "black")) +
  labs(title = titl, x = "lambda_frac", y = "alpha")
```


## look at model based on min bic

```{r}
metrics_obs$auc[metrics_obs$bic_min_index]
beta_bic <- fit_obs[[metrics_obs$bic_min_index[1], metrics_obs$bic_min_index[2]]]$beta

table(abs(beta_bic) > 1e-6)

pgs_selected <- names(beta_bic)[abs(beta_bic) > 1e-6]
pgs_selected
```


## look at model based on min loss
```{r, metrics_min_loss}
metrics_obs$auc[metrics_obs$loss_min_index]
beta_min_loss <- fit_obs[[metrics_obs$loss_min_index[1], metrics_obs$loss_min_index[2]]]$beta
table(abs(beta_min_loss) > 1e-6)

pgs_selected <- names(beta_min_loss)[abs(beta_min_loss) > 1e-6]
head(pgs_selected)

plot(beta_bic, beta_min_loss); abline(0,1)
```
