---
title: "Calculating summary statistics for elastic net"
author: "Dan Schaid"
date: "`r Sys.Date()`"
output: html_document
vignette: >
  %\VignetteIndexEntry{Calculating summary statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```


Create test data of 3 groups with PRS (nprs) and covariates (sex, age, cov1, cov2)


```{r}
library(prsmixsumstats)
```

```{r}
## simulate training data
nprs <- 4000

n1 <- 1000
n2 <- 500
n3 <- 50

dat1 <- sim_test_dat(n1, nprs, prev=.1, beta.sd=2)
dat2 <- sim_test_dat(n2, nprs, prev=.1, beta.sd=2)
dat3 <- sim_test_dat(n3, nprs, prev=.1, beta.sd=2)

## make some y's missing
dat1$y[3:20] <- NA
dat2$y[15:30] <- NA
dat3$y[1:16] <- NA

## make some x's missing
dat1$x[3:5, 4:5] <- NA
dat2$x[20:30, 5:8] <- NA
dat3$x[2:10, 6:9] <- NA
```

# Biobanks Create Summary Statistics (3 demo biobanks)

```{r}
sumstats <- list()
sumstats[[1]] <-  make_sumstats(dat1$x, dat1$y)
sumstats[[2]] <-  make_sumstats(dat2$x, dat2$y)
sumstats[[3]] <-  make_sumstats(dat3$x, dat3$y)
```

# CC: sum over biobanks

```{r}
total_stats <- combine_sumstats(sumstats)
xx <- total_stats$xx
xy <- total_stats$xy

yvar <- attr(total_stats, "yvar")
ysum <- attr(total_stats, "ysum")
nobs <- attr(total_stats, "nobs")

## note that there is no intercept because x and y are centered on their means

penalty_factor <- rep(1,ncol(xx))
## if don't penalize adjusting covariates: should they be penalized??
## penalty_factor[1:4] <- 0
```

# fit a grid of lambda's

```{r}

#library(glmnet)
## alpha weights abs(beta) and (1-alpha) weights beta^2
alpha <- 0.5
lambda_max <- max(abs(xy))/alpha
lambda_frac <- seq(from=1, to=.05, by= -.05)
lambda_vec <- lambda_max * lambda_frac
nfit <- length(lambda_vec)

# suggest setting this to 500
# for vignette, limit number of iterations for time
maxiter <- 100

beta_init <- rep(0, ncol(xx))
fit_sumstats <- list()

cat("================ lambda.frac = ", lambda_frac[1], " ==================\n")

fit_sumstats[[1]] <-  glmnet_sumstats(sumstats, beta_init, alpha=alpha, lambda=lambda_vec[1], 
                                penalty_factor, maxiter=maxiter, tol=1e-7,f.adj=2.0, verbose=FALSE)

#for vignette, limit number of iterations to 3
nfit <- 3
for(j in 2:nfit){
  ptm <- proc.time()
  cat("================ lambda.frac = ", lambda_frac[j], " ==================\n")
  ## use warm start for next fit
  beta_init <- fit_sumstats[[j-1]]$beta
  fit_sumstats[[j]] <-  glmnet_sumstats(sumstats, beta_init, alpha=alpha, lambda=lambda_vec[j], 
                                    penalty_factor, maxiter=maxiter, tol=1e-7,f.adj=32.0, verbose=FALSE)
  print(proc.time() - ptm)
}
```

